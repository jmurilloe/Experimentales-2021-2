clear all; close all;
Vr = [0	0	-0.01	-0.02	-0.03	-0.03	-0.05	-0.05	-0.06	-0.06	-0.07000000000000001	-0.07000000000000001	-0.08	-0.09	-0.09	-0.1	-0.1	-0.11	-0.11	-0.12	-0.12	-0.13	-0.14	-0.14	-0.15	-0.16	-0.16	-0.17	-0.17	-0.18	-0.19	-0.2	-0.2	-0.21	-0.22	-0.23	-0.24	-0.24	-0.25	-0.26	-0.27	-0.28	-0.28	-0.29	-0.3	-0.31	-0.31	-0.32	-0.33	-0.34	-0.34	-0.35	-0.36	-0.37	-0.37	-0.38	-0.39	-0.4	-0.4	-0.4	-0.41	-0.42	-0.43	-0.44	-0.45	-0.46	-0.46	-0.48	-0.49	-0.49	-0.5	-0.5	-0.51	-0.52	-0.53	-0.54	-0.5600000000000001	-0.5600000000000001	-0.57	-0.58	-0.6	-0.6	-0.61	-0.62	-0.63	-0.64	-0.66	-0.66	-0.68	-0.6899999999999999	-0.7	-0.71	-0.72	-0.73	-0.74	-0.74	-0.76	-0.77	-0.77	-0.78	-0.79	-0.8	-0.8100000000000001	-0.82	-0.83	-0.84	-0.86	-0.87	-0.88	-0.89	-0.9	-0.92	-0.93	-0.9399999999999999	-0.95	-0.97	-0.98	-0.99	-1	-1.02	-1.03	-1.05	-1.06	-1.07	-1.08	-1.1	-1.11	-1.12	-1.13	-1.14	-1.15	-1.17	-1.18	-1.19	-1.2	-1.21	-1.22	-1.23	-1.25	-1.26	-1.27	-1.28	-1.29	-1.3	-1.32	-1.33	-1.35	-1.36	-1.37	-1.39	-1.4	-1.42	-1.44	-1.45	-1.46	-1.48	-1.49	-1.5	-1.52	-1.53	-1.54	-1.56	-1.57	-1.58	-1.59	-1.61	-1.62	-1.62	-1.64	-1.66	-1.67	-1.69	-1.7	-1.72	-1.74	-1.75	-1.76	-1.78	-1.8	-1.82	-1.84	-1.85	-1.87	-1.88	-1.89	-1.91	-1.92	-1.93	-1.95	-1.96	-1.97	-1.98	-2	-2.01	-2.02	-2.04	-2.05	-2.07	-2.09	-2.1	-2.12	-2.13	-2.15	-2.17	-2.18	-2.2	-2.21	-2.23	-2.24	-2.26	-2.27	-2.29	-2.31	-2.32	-2.34	-2.35	-2.37	-2.38	-2.4	-2.42	-2.43	-2.45	-2.46	-2.48	-2.5	-2.52	-2.54	-2.55	-2.58	-2.59	-2.61	-2.63	-2.65	-2.68	-2.69	-2.71	-2.72	-2.75	-2.77	-2.77	-2.8	-2.82	-2.83	-2.85	-2.86	-2.89	-2.91	-2.92	-2.94	-2.96	-2.98	-3	-3.01	-3.04	-3.06	-3.07	-3.09	-3.11	-3.13	-3.15	-3.16	-3.18	-3.19	-3.21	-3.23	-3.24	-3.25	-3.27	-3.29	-3.32	-3.33	-3.35	-3.37	-3.39	-3.41	-3.43	-3.45	-3.47	-3.49	-3.51	-3.52	-3.54	-3.55	-3.58	-3.59	-3.61	-3.62	-3.64	-3.65	-3.66	-3.69	-3.71	-3.73	-3.75	-3.76	-3.78	-3.8	-3.81	-3.83	-3.85	-3.87	-3.88	-3.9	-3.92	-3.93	-3.96	-3.98	-3.99	-3.98	-3.98];
I = [92.7	92.8	92.40000000000001	90.59999999999999	89.3	88	86.90000000000001	85.7	85.2	84.09999999999999	82.8	82.40000000000001	80.7	79.7	78.90000000000001	78.2	77.59999999999999	76.7	75.90000000000001	73.90000000000001	73.5	72.3	69.40000000000001	69.90000000000001	68.8	68.2	66.59999999999999	66.7	65.40000000000001	65.2	63.7	62.6	61.5	61.2	60.3	58.8	58.6	58.4	56.9	56.6	55.3	54.2	53.6	52.6	52.1	51.2	50	49.4	48.7	47.6	46.3	45.9	45.2	43.8	43.1	42.6	42	41.2	40.7	40.5	39.7	38.5	37.9	37.9	36.1	35.4	35	34.2	32.8	32.3	32	31.8	30.7	29.7	29.3	28.7	27.6	26.5	26.2	25.4	24.3	23.8	23.1	22.1	21.4	20.9	20	19	18.4	17.6	17.1	16.4	15.5	15.2	14.5	13.8	13.3	12.9	12.3	11.8	11.2	11	10.3	9.6	9.199999999999999	8.6	8.300000000000001	7.6	6.9	6.4	5.9	5.8	5	4.6	4.3	3.7	3.5	3	2.6	2.2	2	1.6	1.3	1	0.7	0.5	0.4	0.2	0.1	-0.1	-0.3	-0.4	-0.5	-0.5	-0.7	-0.7	-0.9	-0.9	-1	-1	-1.1	-1.1	-1.2	-1.1	-1.3	-1.3	-1.3	-1.3	-1.3	-1.4	-1.4	-1.5	-1.4	-1.3	-1.4	-1.4	-1.5	-1.4	-1.5	-1.5	-1.5	-1.4	-1.4	-1.6	-1.5	-1.5	-1.5	-1.4	-1.6	-1.5	-1.4	-1.5	-1.5	-1.5	-1.5	-1.4	-1.5	-1.6	-1.6	-1.6	-1.4	-1.6	-1.5	-1.4	-1.5	-1.5	-1.4	-1.5	-1.5	-1.6	-1.4	-1.5	-1.5	-1.5	-1.4	-1.5	-1.6	-1.5	-1.5	-1.5	-1.5	-1.5	-1.6	-1.5	-1.6	-1.5	-1.5	-1.6	-1.5	-1.6	-1.5	-1.5	-1.5	-1.5	-1.6	-1.6	-1.7	-1.6	-1.5	-1.5	-1.5	-1.5	-1.5	-1.6	-1.6	-1.6	-1.6	-1.5	-1.6	-1.5	-1.6	-1.6	-1.6	-1.6	-1.5	-1.6	-1.6	-1.6	-1.6	-1.5	-1.6	-1.6	-1.5	-1.5	-1.6	-1.7	-1.6	-1.6	-1.7	-1.7	-1.6	-1.6	-1.6	-1.7	-1.7	-1.6	-1.6	-1.7	-1.6	-1.6	-1.6	-1.7	-1.6	-1.7	-1.6	-1.5	-1.7	-1.7	-1.6	-1.7	-1.6	-1.6	-1.6	-1.6	-1.6	-1.7	-1.7	-1.7	-1.7	-1.6	-1.6	-1.6	-1.6	-1.6	-1.6	-1.7	-1.6	-1.6	-1.6	-1.6	-1.6	-1.6	-1.7	-1.6	-1.5	-1.6	-1.6	-1.5	-1.6	-1.6	-1.7	-1.6	-1.6	-1.6	-1.6	-1.6	-1.7	-1.6	-1.5	-1.5];

volmax = -1.25; %%%%%%%%%%%%%%%%%%%% se selecciona el valor de voltaje hasta el que se considera, inicialmente, que esta el 0
N=find(Vr == volmax); n = 0; x(1) = 0; y(1) = 0;
for n = N:size(Vr,2)
  x(n-(N-1)) = Vr(n);
  y(n-(N-1)) = I(n);
end

prom=mean(y)
destan=std(y) 
size(y,2)

xx = -4:1:0; Iinf =prom-3*destan; Iprom=prom; Isup= prom+3*destan; 
yysup = Isup*ones(1,5);
yyprom = Iprom*ones(1,5);
yyinf = Iinf*ones(1,5);

volmin = -0.41; %%%%%%%%%%%%%%%%%%%% <------------SELECCIONAR el valor de voltaje desde el que se considera, inicialmente, que la pendiente es constante y != 0
in=find(Vr == volmin); x2 = Vr(3:in); y2 = I(3:in);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Minimos Cuadrados %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
size(x2)
size(y2)
Nin = size(x2)(2)
format long
sx2y2 = sum(x2.*y2); sx2x2 = sum(x2.*x2); sy2y2 = sum(y2.*y2); sx2 = sum(x2); sy2 = sum(y2);
a = (((Nin)*(sx2y2))-((sx2)*(sy2)))/(((Nin)*(sx2x2))-((sx2)*(sx2)))
b = (((sx2x2)*(sy2))-((sx2)*(sx2y2)))/(((Nin)*(sx2x2))-((sx2)*(sx2)))
e = (y2-((a*x2)+b)).^2; sei = sum(e);
iNincertidumbrea=sqrt((sei)/(Nin-2))*sqrt((Nin)/(((Nin)*(sx2x2))-((sx2)*(sx2))))
iNincertidumbreb=sqrt((sei)/(Nin-2))*sqrt((sx2x2)/(((Nin)*(sx2x2))-((sx2)*(sx2))))
r = (((Nin)*(sx2y2))-((sx2)*(sy2)))/(sqrt(((Nin)*(sx2x2))-((sx2)*(sx2)))*sqrt(((Nin)*(sy2y2))-((sy2)*(sy2))))

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Calculo de puntos de corte %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Voinf = (Isup-b)/(a);Vo = (Iprom-b)/(a);Vosup = (Iinf-b)/(a);
yf1= -2:0.01:Isup;
xf1= Voinf*ones(1,length(yf1));
yf2= -2:0.01:Iprom;
xf2= Vo*ones(1,length(yf2));
yf3= -2:0.01:Iinf;
xf3= Vosup*ones(1,length(yf3));
xx2 = -1.2:0.01:1;
yy2 = a.*xx2+b; %vectores para graficar la recta del ajuste, para evidenciar el corte con el eje I=0 en la grafica inicial (1) 

figure(1);clf;
subplot(2,2,1:2);plot (Vr,I,'r.');grid on;xlabel('V_{r}[V]');ylabel('I[A]');legend('Datos Experimentales','Location','northwest');title('Relacion de I en funcion de V_{r}')
subplot(2,2,3:4);plot (x2,y2,'c.');grid on;axis([-4 0 -20 100]);xlabel('V_{r}[V]');ylabel('I[A]');legend('Datos Experimentales','Location','northwest'); title('Primera consideracion de region con pendiente constante')

figure(2);clf;
subplot(2,1,1); plot (Vr,I,'r.',xx,yysup,'m-',xx,yyprom,'b-',xx,yyinf,'m-');grid on;axis([-4 0 -20 100]);title('A)');xlabel('V_{r}[V]');ylabel('I[A]');legend('Datos Experimentales','I_{prom}+3\sigma','I_{prom}','I_{prom}-3\sigma','Location','northwest')
subplot(2,1,2); plot (Vr,I,'r.',xx,yysup,'m-',xx,yyprom,'b-',xx,yyinf,'m-');grid on; title('B)'); xlabel('V_{r}[V]');ylabel('I[A]');axis([-4 0 -2 -0.8])

figure(3); clf;
plot(xx2,yy2,'k-',xx,yysup,'m-',xx,yyprom,'b-',xx,yyinf,'m-',xf1,yf1,'g',xf2,yf2,'c',xf3,yf3,'g');grid on; axis([-0.72 -0.708 -2 -1]);xlabel('Corriente de electrones, I[u.a]');ylabel('Potencial de retardo, V[V]'); title('Curva I vs V caracteristica'); legend('Ajuste MMC','I_{prom}+3\sigma','I_{prom}','I_{prom}-3\sigma','V_{0-inf}','V_{0}','V_{0-sup}','Location','northwest')
%%%%%%%%%%%%% Informacion final de interes
Iinf
Iprom
Isup
Voinf
Vosup
Vo
deltaVo1 = Vo-Vosup